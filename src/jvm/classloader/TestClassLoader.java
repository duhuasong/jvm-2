package jvm.classloader;

import java.util.ArrayList;
import java.util.List;

import jvm.engine.instruction.Instruction;
import jvm.memory.MethodInfo;
import jvm.memory.ClassInfo;
import jvm.memory.Memory;
/**
 * 把类的信息加载到Memory中
 * @author yangrui
 *
 */
public class TestClassLoader implements IClassLoader{
	
	/**
	 * 加载类，如：
	 * className = "test.MyTest";
	 * @param className
	 */
	public void loadClass(String className) {

		ClassInfo myTestClass = assembleClass(className);
		
		//设置Memory的classPool
		Memory.classPool.put(className, myTestClass);
		//找到入口main方法，如果有的话，设置Memory中的entrancesMethods
		entrancesMethodsFilter(myTestClass);

	}

	private  ClassInfo assembleClass(String className) {
		
		ClassInfo classInfo = new ClassInfo(className);
		
		assembleClassBaseMethods(classInfo);

		return classInfo;
	}

	private  void assembleClassBaseMethods(ClassInfo classInfo) {
		//设置main方法
		MethodInfo mainMethod = new MethodInfo();
		List<Instruction> mainInstruct = new ArrayList<Instruction>();
		mainInstruct.add(new Instruction("iconst_1", null));
		mainInstruct.add(new Instruction("istore_1", null));
		mainInstruct.add(new Instruction("bipush", "11"));
		mainInstruct.add(new Instruction("istore_2", null));
		mainInstruct.add(new Instruction("iload_1", null));
		mainInstruct.add(new Instruction("iload_2", null));
		mainInstruct.add(new Instruction("invokestatic", "test.MyTest.add", "2"));// 第三个代表操作数中的两个参数
		mainInstruct.add(new Instruction("istore_3", null));
		mainInstruct.add(new Instruction("return", null));
		mainMethod.setClassInfo(classInfo);
		mainMethod.setMethodInstructions(mainInstruct);
		mainMethod.setName("test.MyTest.main");
		
		//设置add方法
		MethodInfo addMethod = new MethodInfo();
		List<Instruction> addInstruct = new ArrayList<Instruction>();
		addInstruct.add(new Instruction("iload_0", null));
		addInstruct.add(new Instruction("iload_1", null));
		addInstruct.add(new Instruction("iadd", null));
		addInstruct.add(new Instruction("ireturn", null));
		addMethod.setClassInfo(classInfo);
		addMethod.setMethodInstructions(addInstruct);
		addMethod.setName("test.MyTest.add");
		
		//设置class的BaseMethod
		List<MethodInfo> BaseMethods = new ArrayList<MethodInfo>();
		BaseMethods.add(mainMethod);
		BaseMethods.add(addMethod);
		classInfo.setMethods(BaseMethods);
		
	}
	
	/**
	 * 如果类里面有个main方法，把该方法加入Memory.entrancesMethods中
	 * @param classInfo
	 */
	private  void entrancesMethodsFilter(ClassInfo classInfo) {
		if(classInfo.getMethods()!=null){
			for(MethodInfo BaseMethod : classInfo.getMethods()){
				if(BaseMethod.getName().endsWith(".main")){
					try {
						Memory.entrancesMethods.put(BaseMethod);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}
		}
		
	}


}
